# Backend BotFarm
Асинхронный Restful FastAPI сервис - имитация ботфермы для организации E2E-тестирования. Решает проблему безопасного распределения тестовых аккаунтов между параллельными тестами, предоставляя API для получения кредов ботов с механизмом блокировки и авторизацией.

## Стек технологий

**Бэкенд:**
*   **FastAPI** - асинхронный веб-фреймворк с автогенерацией документации (Swagger)
*   **Pydantic** - валидация данных и схемы API

**База данных:**
*   **PostgreSQL** - основное хранилище
*   **SQLAlchemy 2.0** - асинхронный ORM
*   **Alembic** - миграции схемы БД

**Инфраструктура:**
*   **Docker & Docker Compose** - контейнеризация сервисов
*   **UV** - менеджер зависимостей и виртуальных окружений

**Тестирование и качество кода:**
*   **pytest** - фреймворк для модульного и интеграционного тестирования
*   **isort, black, flake8** - автоматическое форматирование и статический анализ кода

## Архитектура и логика работы

### Доменная модель
- **Домен `regular`** - операторы системы, проходят OAuth2 аутентификацию
- **Домен `canary`** - тестовые боты, управляются через API

### Жизненный цикл бота
1. **Доступность** - бот свободен (`locktime = null`)
2. **Захват** - regular-пользователь блокирует бота для теста
3. **Использование** - бот занят в E2E-тесте (`locktime` установлен)
4. **Освобождение** - бот возвращается в пул после теста

### Ключевые эндпоинты
- `POST /login` - аутентификация regular-пользователя
- `GET /users` - получение списка всех пользователей (требует JWT)
- `POST /users/{id}/lock` - захват бота для тестирования
- `DELETE /users/{id}/lock` - освобождение бота

### Особенности реализации
- Асинхронные операции для высокой производительности
- `SELECT FOR UPDATE` для предотвращения race condition при блокировках
- Подробные HTTP-ответы с обработкой всех edge-cases

## Быстрый старт

```bash
# 1. Клонирование репозитория
git clone <repository-url>
cd Backend-BotFarm

# 2. Настройка переменных окружения и секретов
make env

# 3. Запуск приложения
make up

# 4. Доступ к БД через утилиту psql
make psql

# 5. Тесты
make test
```

После запуска документация API будет доступна по адресу: http://localhost:8080/swagger

Для тестирования API используйте учетные данные пользователя, созданного автоматически при первом запуске:

- **Логин:** `admin@admin.com`  
- **Пароль:** `admin`

## Ключевые особенности

**Архитектура и производительность:**
- **Асинхронная архитектура** на FastAPI через async/await
- **Restful** реализация API
- **Dependency Injection** для управления зависимостями и тестируемости
- **Изолированный CRUD слой** с четким разделением ответственности

**Безопасность и надежность:**
- **JWT аутентификация** по стандарту OAuth2
- **SELECT FOR UPDATE** для предотвращения race condition при блокировках
- **Pydantic валидация** всех входных и выходных данных
- **Переменные окружения** через .env файлы как единственный источник истины для хранения секретов

**Разработка и эксплуатация:**
- **UV пакетный менеджер** для быстрой сборки и развертывания
- **Alembic миграции** с автоматическим применением при старте сервиса
- **Контейнеризация** Docker с оркестрацией через Docker Compose
- **Полное тестирование** через pytest с запуском make test

**Качество кода:**
- **Type hints, docstrings** для всей кодовой базы
- **Статический анализ** с flake8 и автоматическое форматирование isort/black
- **Разделение логики** на валидационную (Pydantic) и сервисную (business logic)

## Направления развития

- **Observability** - комплексное логирование, мониторинг через Prometheus/Grafana и трейсинг запросов
- **Kubernetes** - оркестрация контейнеров, auto-scaling и отказоустойчивая архитектура
